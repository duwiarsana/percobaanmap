# Indonesia Map Explorer — Data Loading Logic and Required Metadata

This document summarizes how the app loads province, district (kabupaten/kota), and subdistrict (kecamatan) boundaries, and which metadata fields are critical to make it work reliably.

## Overview of Flow

1. **Provinces layer**
   - Loaded from `public/data/prov_37.geojson` in `src/App.tsx`.
   - Clicking a province triggers a zoom and sets `selectedProvince`.

2. **Districts layer** (within selected province)
   - `MapController` fetches the configured districts GeoJSON file for the province: `provCfg?.districtsFile || '/data/kab_37.geojson'`.
   - It filters features to those that belong to the selected province by code/name (see District Filtering below).

3. **Subdistricts layer** (after clicking a district)
   - On district click, `handlers.createOnEachDistrict()` identifies the district code and sets `selectedDistrict` and `selectedDistrictId` (normalized to 4 digits, e.g., `3510`).
   - `MapController` calls `data-loader.loadSubdistrictData(normalizedId)`.
   - Loader attempts to fetch all individual kecamatan files listed in config; if none load, it tries the district’s fallback combined GeoJSON.

## File/Module Responsibilities

- `src/App.tsx`
  - Loads provinces and manages selection state.
  - Loads districts for the selected province using `DATA_CONFIG[provId].districtsFile` and filters to that province.
  - Delegates subdistrict loading to `MapController`.

- `src/map/handlers.ts`
  - District click handler: resolves a consistent 4-digit district ID using the district’s name matched against config (preferred) or properties.

- `src/data-loader.ts`
  - `loadSubdistrictData(districtId)`: finds district config, loads all subdistrict files (`{path}/{id}.geojson`), enhances feature properties, or falls back to `{path}/{fallbackFile}`.

- `src/data-config.ts`
  - Exports `DATA_CONFIG` and `findDistrictConfig()` used across the app.

- `src/types/data-config.ts`
  - Defines the shape of province/district metadata the app expects.

- `src/data/prov-35-jawa-timur.ts`
  - Province-specific config for East Java; generated by `scripts/gen_prov35_config.py`.

## District Filtering (Province → Districts)

When loading districts for a selected province in `App.tsx`:
- It fetches `districtUrl = DATA_CONFIG[provId]?.districtsFile || '/data/kab_37.geojson'`.
- For each district feature:
  - Derive a 4-digit regency code: `getDistrictId(props)` (via `src/utils/geojsonProps.ts`).
  - Check the first two digits against the selected province’s ID.
  - Fallbacks: match by district name through `findDistrictConfig(name)`, or compare province ids present in the feature.
- It writes `regency_code` into each feature’s properties to stabilize downstream handling.

## District Matching on Click

`createOnEachDistrict()` determines the ID to load subdistricts:
- Prefer config match by district name: `cfg = findDistrictConfig(districtName)` → `cfg.id` (ensures canonical 4-digit code).
- Fallback to values derivable from the feature’s props: `getDistrictId(props)`.
- Normalize to a strict 4-digit code (`/^\d{4}$/`). If invalid, it aborts.

## Subdistrict Loading Logic

`loadSubdistrictData(districtId)`:
- Resolves `districtConfig = findDistrictConfig(districtId)` from `DATA_CONFIG`.
- Attempts to load all subdistrict files in order:
  - URL pattern: `${districtConfig.path}/${sub.id}.geojson` where `sub.id` is the basename without extension.
- If zero subdistrict files load and `fallbackFile` exists:
  - Load `${districtConfig.path}/${districtConfig.fallbackFile}`.
- On success, it returns a combined FeatureCollection.

### Feature Enhancement
For each loaded subdistrict feature, the loader adds consistent properties for robust styling/tooltip logic:
- Names: `kecamatan`, `kec_name`, `KECAMATAN`, `NAMA`, `name`, etc.
- Codes: `district_code`, `kab_id`, `kabupaten_id`, `ID_KABUPATEN`, etc., all set to the resolved district code.

## Required Metadata Fields

Defined in `src/types/data-config.ts`:

- **ProvinceConfig**
  - `id: string` — Province code (e.g., `'35'`).
  - `name: string` — Province name.
  - `path: string` — Base path for province data directory (not used directly for subdistrict fetches but kept for consistency).
  - `districtsFile?: string` — URL to a districts GeoJSON collection used for filtering. Example: `'/data/jawa_timu_kab.geojson'`.
  - `districts: Record<string, DistrictConfig>` — Map of district code (`'3510'`) to config.

- **DistrictConfig**
  - `id: string` — 4-digit district (regency/city) code, e.g., `'3510'`.
  - `name: string` — District display name; must match the label in districts GeoJSON for name-based lookups.
  - `path: string` — Directory containing kecamatan files. Example: `'/data/id35_jawa_timur/id3510_banyuwangi'`.
  - `subdistricts: { id: string; name?: string }[]` — List of subdistrict file basenames without extension. Example: `{ id: 'id3510010_pesanggaran' }`.
  - `fallbackFile?: string` — Combined district GeoJSON file within the same directory. Example: `'id3510_banyuwangi.geojson'`.
  - `uuid?: string` and `alternativeIds?: string[]` — Optional; enable matching by UUID or other known identifiers.

## File/Directory Naming Conventions

- Province file: `/data/prov_37.geojson`.
- Districts collection: `/data/kab_37.geojson` (or province-specific like `/data/jawa_timu_kab.geojson`).
- District directory: `/data/id{prov}_{slug}/id{districtCode}_{slug}/`.
- Subdistrict file basename: `id{7+ digits}_{slug}` (exact basenames as on disk) without extension in config, with `.geojson` appended on fetch.
- District fallback file: same basename as the district directory, with `.geojson` extension (e.g., `id3510_banyuwangi.geojson`).

## Common Pitfalls and Fixes

- **Name mismatches**: If district names in the districts GeoJSON differ from config names, `findDistrictConfig(name)` may not resolve; ensure config `name` closely matches or add `alternativeIds`/`uuid`.
- **Path mismatches**: Ensure `DistrictConfig.path` matches the actual folder under `public/data`. For Bali it’s `/data/id51_bali/id{district}/`, for East Java it’s `/data/id35_jawa_timur/id{district}/`.
- **Missing subdistrict files**: Keep `fallbackFile` present as a safety net.
- **Stale state during animations**: Subdistrict loading is skipped while `isZooming` is true to prevent race conditions.

## Generator for East Java (35)

- Script: `scripts/gen_prov35_config.py`
  - Scans `public/data/id35_jawa_timur/` for district directories.
  - Builds `src/data/prov-35-jawa-timur.ts` with `path`, full `subdistricts` (file basenames), and `fallbackFile` when present.
  - Keeps `districtsFile: '/data/jawa_timu_kab.geojson'` on the province.
- Usage:
  ```bash
  python3 scripts/gen_prov35_config.py
  ```

## Minimal Checklist When Adding a Province/District

- **ProvinceConfig**: set `id`, `name`, `path`, and `districtsFile`.
- **DistrictConfig entries**: for each district
  - `id` = 4-digit code, `name` = display name, `path` = exact folder path
  - `subdistricts` = all file basenames (no `.geojson`)
  - `fallbackFile` = combined file if available
- Verify at least one district by clicking and checking console/network logs.
